name: macOS build

on:
  push:
    branches: ["*"]
    tags: ["v*"]
  pull_request:
    branches: ["main"]

jobs:
  build-macos:
    runs-on: macos-latest
    permissions:
      contents: write

    env:
      BUILD_TYPE: Release
      APP_NAME: DKV2

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      ###############################################################
      # 1) Install Qt
      ###############################################################
      - name: Install Qt 6.9.3 (clang_64)
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.9.3"
          host: mac
          target: desktop
          arch: clang_64
          cache: true

      ###############################################################
      # 2) Locate Qt root automatically (no reliance on Qt6_DIR!)
      ###############################################################
      - name: Detect Qt installation
        id: qtloc
        run: |
          echo "Searching for macdeployqt …"
          QT_ROOT=$(dirname $(dirname $(find $RUNNER_WORKSPACE/Qt -name "macdeployqt" -print -quit)))

          if [ -z "$QT_ROOT" ]; then
              echo "::error::Qt root not found!"
              exit 1
          fi

          echo "Qt found at: $QT_ROOT"

          echo "QT_ROOT_DIR=$QT_ROOT" >> $GITHUB_ENV
          echo "Qt6_DIR=$QT_ROOT/lib/cmake/Qt6" >> $GITHUB_ENV

      ###############################################################
      # 3) Install Ninja
      ###############################################################
      - name: Install Ninja
        run: brew install ninja

      ###############################################################
      # 4) Configure (CMake)
      ###############################################################
      - name: Configure
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR"

      ###############################################################
      # 5) Build
      ###############################################################
      - name: Build
        run: cmake --build build --config ${BUILD_TYPE} -j3

      ###############################################################
      # 6) Install bundle
      ###############################################################
      - name: Install bundle
        run: |
          cmake --install build --config ${BUILD_TYPE} \
            --prefix "${PWD}/build/install"

      ###############################################################
      # 7) Deploy Qt (macdeployqt) — now always found!
      ###############################################################
      - name: Deploy with macdeployqt
        run: |
          APP_PATH="build/install/${APP_NAME}.app"
          MACDEPLOYQT="$QT_ROOT_DIR/bin/macdeployqt"

          echo "QT_ROOT_DIR: $QT_ROOT_DIR"
          echo "Using macdeployqt: $MACDEPLOYQT"

          if [ ! -f "$MACDEPLOYQT" ]; then
              echo "::error::macdeployqt not found!"
              ls -R "$QT_ROOT_DIR"
              exit 1
          fi

          "$MACDEPLOYQT" "$APP_PATH" -always-overwrite -verbose=2

      ###############################################################
      # 8) Create DMG
      ###############################################################
      - name: Create DMG
        run: |
          APP_PATH="build/install/${APP_NAME}.app"
          DMG_PATH="build/${APP_NAME}.dmg"
          hdiutil create "$DMG_PATH" \
            -volname "${APP_NAME}" \
            -srcfolder "$APP_PATH" \
            -ov -format UDZO

      ###############################################################
      # 9) Upload Artifact
      ###############################################################
      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: macOS-DMG
          path: build/${APP_NAME}.dmg
